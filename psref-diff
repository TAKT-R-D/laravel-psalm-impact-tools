#!/usr/bin/env zsh
# psref-diff - Reference Finder for Changed PHP Files (Laravel/Psalm)
#
# Summary:
#   This script finds all references to changed PHP files (vs a base git ref) in a Laravel project using Psalm.
#   It lists all changed PHP files compared to the specified base, and runs psref on each.
#
# Usage:
#   bin/psref-diff [base-ref]
#     - base-ref: (optional) The git reference to compare against (default: remotes/origin/main)
#
# Example:
#   bin/psref-diff
#   bin/psref-diff main
#
[[ -z "$ZSH_VERSION" ]] && exec zsh "$0" "$@"
set -euo pipefail

BASE="${1:-remotes/origin/main}"

## List changed files, filter to .php, and only include files that currently exist
changed=()
while IFS= read -r p; do
  [[ -z "$p" ]] && continue
  [[ "${p:l}" == *.php ]] || continue
  [[ -f "$p" ]] || continue   # Exclude deleted files (D)
  changed+=("$p")
done < <(git diff --name-only "$BASE")

(( ${#changed} )) || { print -r -- "No changed PHP files vs $BASE."; exit 0; }

for p in "${changed[@]}"; do
  print -r -- "=== $p ==="
  ./bin/psref "$p" || true
  print -r -- ""
done
